# 第9章 可编程的shell.shell变量和环境：编写自己的shell

## 本章主要思路
### 什么是shell脚本
### shell脚本有哪些特性
### shell的编程特性

#### shell中if的工作原理
#### 如何在自己编写的shell中增加流程控制（if then else）

### shell变量：局部和全局
#### shell局部变量的使用和实现
#### shell全局变量的使用和实现（export环境变量）

## 小结主要内容
- Unix shell运行一种称为脚本的程序。一个shell脚本可以运行程序、接受用户输入、使用变量和使用复杂的控制逻辑。  
- if..then语句依赖于下述惯例:Unix程序返回0以表示成功。shell使用wait来得到程序的退出状态。  
- shell编程语言包括变量。这些变量存储字符串，它们可以在任何命令中使用。shell变量是脚本的局部变量。  
- 每个程序都从调用它的进程中继承一个字符串列表，这个列表被称为环境。环境用来保存会话(session)的全局设置和某个程序的参数设置，shell允许用户查看和修改环境。  

## 什么是shell脚本
shell是一个编程语言解释器，这个解释器解释从键盘输入的命令，也解释存储在脚本中的命令序列。  

### shell脚本包含一系列命令
shell忽略以字符#开始的行，脚本的余下部分由命令组成，shell逐条执行命令直到文件末尾或者shell执行到exit命令。  

### shell脚本执行的两种方法
#### 1. 可以把脚本文件名作为参数传给shell来执行脚本(脚本命名没有任何要求，不一定非要sh结尾)
```
$ sh scriptO
```
#### 2. 还可以通过设置文件的执行权限，然后输人文件名来执行脚本
```
$ chmod + x script
```
对于一个脚本只需要执行一次chmod，可执行位将保持不变直到下一次再改变它。用第二种方法，也就是用改变文件可执行属性的方法来启动脚本会更加方便。将脚本设置成可执行的，然后像运行系统命令或自己编写的程序一样来执行脚本。  

## shell脚本有哪些特性
### 变量
脚本中可以定义变量。在script2中，定义了名为BOOK和NAME两个变量，并在定义之后使用了它们，用前缀$来取得变量的值。变量名不一定要大写，只是习惯上将其大写。  
### 用户输入
read命令告诉shell要从标准输入中读人一个字符串。可以使用read来创建交互的脚本，也可以从文件或管道中读人数据。  

### 控制
脚本包括了 if..then..else..fi、还有while、case、for等  

### 环境
脚本使用一个名为HOME的变量。HOME的值是你的主目录的路径。HOME变量是由login程序设置的，可以被login进程的所有子进程使用。HOME变量是多个环境变量(environment variables)中的一个。这些环境变量记录了个性化设置。而这些设置能影响很多程序的行为。比如，TZ变量记录了当前的时区。将TZ设置为”EST5EDT”是告诉那些使用ctime的程序，比如date或Is 1，应该显示美国东部时间。  


## shell的编程特性详述

### shell中if的工作原理
shell中的if语句的作用与其他语言的if语句相同：条件检测。如果条件的值为正，则有一部分代码被执行。在shell中，条件是一个命令，返回正值意味着命令运行成功。程序是如何表示成功的呢？  

**exit(0)代表成功**  

程序调用函数exit(0)来表明成功。所有的Unix程序都遵从以0退出表明成功这一惯例。比如，diff命令用来比较两个文本文件。如果两个文件相同，diff返回0以表明成功。类似地，mv、cp和rm都以相同的方式表明成功。脚本中的if.. then语句基于以0退出表示成功这个假设。  

**if的另一特性**  

如果if后的条件是一系列的命令，那么最后一个命令的exit值被用作这个语句块的条件值，并由此来决定条件是否成立。  

**if的工作流程**  

- shell运行if之后的命令  
- shell检查命令的exit状态  
- exit的状态为0意味着成功，非0意味着失败  
- 如果成功，shell执行then部分的代码  
- 如果失败，shell执行else部分的代码  
- 关键字fi标识if块的结束  

## shell变量：局部和全局


像其它的程序语言一样，Unix shell也有变量。能对这些变量赋值，也可从这些变量取值，列出所有变量。这类变量一般为局部变量。  

在前面提到过了，像HOME和TZ这样的变量可以让用户把个性化设置传递给程序，这些变量的作用有点象全局变量，它们可以被所有shell的子进程存取。  

### shell局部变量的使用和实现

变量名是字符A-Z、a-z、0-9和‘_’的组合。第一个字母不能是数字。变量名是大小写敏感的。  

变量的值是字符串。变量都是字符串类型的，没有数值类型的变量。所有的操作都是字符串操作。  

列出所有变量使用set命令。set命令列出当前shell定义的所有变量，包括全局变量。  


### shell全局变量的使用和实现（export环境变量）

Unix允许用户在称之为环境(environment)的地方以变量的形式存放这些设置。每个用户有一个惟一的主目录、用户名、邮件文件、终端类型和喜欢用的编辑器，很多个性化的设置由环境中的变量记录。  

环境不是shell的一部分。但是shell包括一些可以让用户读取和修改环境的命令。  

#### 列出所有的环境变量  
env命令列出当前所有环境设置。  

#### 更新环境

**var=value**   

通过对变量赋值就可以更新环境设置。比如，如果浏览器支持法语消息和菜单，可以通过设置LANG=fr来启用法语。  

**export var**  

使用shell内置的命令export向环境添加新的变量。如果var是一个局部变量，那么它将被添加到环境里。如果var不存在, shell会创建一个。bash允许通过用export var=value将创建和输出合并为一步。  

**在C程序中读入环境**

使用标准的C库函数getenv也可以得到环境变量的值：  
```C
# include<stdlib.h>
int main()
{
  char *cp = getenv("LANG");
  if (cp != NULL && strcmp(cp,"fr")== 0)
    printf("Bonjour\n");
  else
    printf("Hello\n");
  return 0;
}
```

#### 什么是环境以及它是如何工作的
环境是每个程序都可以存取的一个字符串数组，如下图所示。每个数组中的字符串都以var-value这样的形式出现，数组的地址被存放在一个名为environ的全局变量里。环境就是environ指向的字符串数组，读环境就是读这个字符串数组，改变环境就是改变字符串、改变这个数组中的指针或者将这个全局指针指向其他数组。  

<div align=center><img src="https://github.com/KyelYang/c-plus-Interview-data/blob/master/02-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/03-Unix_Linux%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5%E6%95%99%E7%A8%8B/02-image/84.jpg" width = 60% height = 60% /></div>

**如果只是简单地将变量数组复制到子进程中会出现问题**  

exec清除了所有的数据！  

在讨论exec系统调用时候知道，对它的调用就像换脑，用目标程序的代码和数据替换调用程序的代码和数据。但是environ指针指向的数组是惟一的例外，当内核执行系统调用execve时，它将数组和字符串复制到新的程序的数据空间，如图所示  

<div align=center><img src="https://github.com/KyelYang/c-plus-Interview-data/blob/master/02-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/03-Unix_Linux%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5%E6%95%99%E7%A8%8B/02-image/85.jpg" width = 60% height = 60% /></div>  

在生成子进程的过程中，观察environ数组的变化。可以看到，fork完整地复制父进程，包括代码和数据，数据中包括了环境。exec清除原来进程中的所有代码和数据，插入新程序的代码和数据。只有通过参数execvp传递的数据和存储在环境中的字符串可以从旧程序复制到新程序。  

**子进程不能修改父进程的环境**  

子程序中环境的设置是父进程环境的复本，子进程不能修改父进程的环境。因为在进程调用fork和exec时整个环境都被自动的复制了，所以通过环境来传递数据比较方便、快捷。  


**在smsh中增加环境变量**  

首先,shell要将环境中的变量添加到自己的变量列表里。然后,shell的用户要能够修改和添加环境变量。  

- 存取环境变量  
已经知道环境的结构，而且还有一组函数向变量列表添加变量。当shell开始运行的时候，环境中的变量将被复制到自己的变量列表里，如图所示。一旦这些值被复制到变量列表里，就能用set命令和赋值命令来査看和修改这些变量了。  

<div align=center><img src="https://github.com/KyelYang/c-plus-Interview-data/blob/master/02-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/03-Unix_Linux%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5%E6%95%99%E7%A8%8B/02-image/86.jpg" width = 60% height = 60% /></div>  

- 改变环境  
修改环境最简单的方法是构建一个全新的列表，这个列表包含了shell中的所有变量。然后将全局指针environ指向这个列表，如图所示。调用exec，内核将这些设置复制到新的程序中。注意，现在没有被引用的环境列表中依旧存储着原来的值。  

<div align=center><img src="https://github.com/KyelYang/c-plus-Interview-data/blob/master/02-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/03-Unix_Linux%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5%E6%95%99%E7%A8%8B/02-image/87.jpg" width = 60% height = 60% /></div>  







